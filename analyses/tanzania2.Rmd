---
title: "Tanzania Prediction Example"
output:
  html_document
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      warning=FALSE, message=FALSE)
knitr::opts_knit$set(root.dir="../")
```

```{r load_data, echo=FALSE}
library(MLlibrary)
library(dplyr)

NAME <- "tanzania"
tz08 <- load_dataset(NAME)
```

## Data

This is a sample analysis of the tanzania dataset from 2008. There is no official PMT, but the data is a panel, which we will exploit later.

The dataset has `r nrow(tz08)` rows and `r ncol(tz08)` columns.`r nrow(tz08) - nrow(model.matrix(lconsPC ~ .,  tz08))` rows contain missing data, which the models presented here are based on.

Our target variable is log of per capita consumption.

## Models

```{r load_models, echo=FALSE}
joined <- load_models(NAME)
k <- nrow(distinct(joined, fold))
```

We trained a number of different models on the raw data.
We use `r k` fold cross validation for testing predictive accuracy.

The models trained are:

* Least squares: Simple least squares
* Stepwise: Stepwise regression with forward (check) selection and ADD STOPPING CRITERIA
* Lasso: Lasso using cross validated regularization parameter 
* Ridge: Ridge using cross validated regularization parameter 
* rtree: Regression tree using cross validated pruning extent
* forest: Random forests
* **Pairwise interactions**
* Lasso_ix: Lasso using all pairwise interaction terms and cross validated regularization parameter
* Ridge_ix: Ridge using all pairwise interaction terms and cross validated regularization parameter
* **Limiting covariates**
* Lasso_15: As lasso but limited to a maximum of 15 covariates
* Stepwise_15: As stepwise but limited to a maximum of 15 covariates

## Assessments

### Density

The following shows the density plots across the methods. rtree is not displayed since it is a set of point masses. 
```{r density, echo=FALSE}
plot_density_(filter(joined,method!="logistic" & method!="logistic_ix" & method!="rtree"))
```


### Reach vs waste
The following shows, for different poverty thresholds (as quantiles of the population), how the number of poor included increases compared to how the number of rich included increases as the eligibility cutoff increases.
```{r reach_vs_waste, echo=FALSE}
plot_reach_vs_waste_(joined, POINT_COUNT=100)
```
The following is the same graph, for a poverty line at the 40% percentile of the distribution.
```{r reach_vs_waste_0.4, echo=FALSE}
plot_reach_vs_waste_(joined, POINT_COUNT=1000, THRESHOLD = 0.4)
```

### Social welfare (gamma = 2)

The following shows, as the coverage of the program is increased, the social welfare using a targeting rule based on our prediction, divided by the social welfare of using a perfect targeting rule. The social welfare is the sum of the marginal utilities of consumption of recipients, using a CRRA utility function with coefficient of relative risk aversion = gamma.

```{r swf_2, echo=FALSE}
plot_swf_(joined, POINT_COUNT=1000, GAMMA = 2)
```

### Social welfare (gamma = 4)

This is the same graph but with a higher CRRA.

```{r swf_4, echo=FALSE}
plot_swf_(joined, POINT_COUNT=1000, GAMMA = 4)
```

