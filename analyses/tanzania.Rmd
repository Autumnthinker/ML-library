---
title: "Tanzania Prediction Example"
output:
  html_document
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      warning=FALSE, message=FALSE)
knitr::opts_knit$set(root.dir="../")
```

```{r load_data, echo=FALSE}
library(MLlibrary)
library(dplyr)

NAME <- "tanzania"
tz08 <- load_dataset(NAME)
```

## Data

This is a sample analysis of the tanzania dataset from 2008.
The dataset has `r nrow(tz08)` rows and `r ncol(tz08)` columns.
`r nrow(tz08) - nrow(model.matrix(lconsPC ~ .,  tz08))` rows contain missing data.
We ran models on the dataset without the missing data and with the missing data (with missingness indicators).
Our goal is to predict the consumption levels from survey data.
In this case we take the log of per capita consumption as our target variable.

## Models

```{r load_models, echo=FALSE}
all_models <- load_models(NAME)
k <- nrow(distinct(all_models, fold))
no_missing <- filter(all_models, !grepl("missing", method))
```

We trained a number of different models on the raw data.
We use `r k` fold cross validation for testing predictive accuracy.

We also trained each model on a dataset including all pairwise interactions.


## Assessments

### Density
```{r density, echo=FALSE}
no_logistic <- filter(no_missing, !grepl("logistic", method))
plot_density_(no_logistic)
```

### ROC

```{r roc, echo=FALSE}
plot_roc_(no_missing)
plot_roc_(no_missing, THRESHOLD=0.2)
```

### Coverage
```{r accuracy, echo=FALSE}
plot_accuracy_(no_missing, SHOW_TRUE=TRUE, POINT_COUNT=50)
```

We can also display coverage rates at the consumption threshold and at the desired percentile.

```{r accuracy_cutoffs, echo=FALSE}
plot_accuracy_(no_logistic, THRESHOLD=0.2, SHOW_CUTOFFS=TRUE, POINT_COUNT=50)
```

### Budget to the true poor
```{r accuracy_dollars, echo=FALSE}
plot_accuracy_dollars_(no_missing, POINT_COUNT=50)
```

```{r accuracy_dollars_cutoffs, echo=FALSE}
plot_accuracy_dollars_(no_logistic, THRESHOLD=0.2, SHOW_CUTOFFS=TRUE, POINT_COUNT=50)
```

### Social welfare
```{r swf, echo=FALSE}
plot_swf_(no_missing, POINT_COUNT=50)
```

### Leakage
```{r leakage, echo=FALSE}
plot_metric_(leakage, no_missing)
```

### Undercoverage
```{r undercoverage, echo=FALSE}
plot_metric_(undercoverage, no_missing)
```

### CGH
```{r cgh, echo=FALSE}
plot_metric_(cgh, no_missing)
```
